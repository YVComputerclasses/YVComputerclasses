<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recharge</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#f4f6f9; }
    /* Navbar */
    .navbar {
      display:flex; justify-content:space-between; align-items:center;
      background:#2c3e50; padding:12px 20px; color:#fff;
    }
    .nav-left { display:flex; gap:20px; }
    .nav-left a {
      text-decoration:none; color:#fff; font-weight:bold; padding:6px 10px;
      border-radius:6px;
    }
    .nav-left a:hover, .nav-left a.active { background:#1abc9c; }
    .nav-right { position:relative; }
    .user-btn { background:none; border:none; color:#fff; font-size:16px; cursor:pointer; }
    .dropdown {
      display:none; position:absolute; right:0; top:40px;
      background:#fff; color:#333; border-radius:6px;
      box-shadow:0 4px 10px rgba(0,0,0,0.2); min-width:120px;
    }
    .dropdown a { display:block; padding:10px; text-decoration:none; color:#333; }
    .dropdown a:hover { background:#f1f1f1; }
    /* Page content */
    .container {
      max-width:500px; margin:40px auto; background:#fff;
      padding:20px; border-radius:12px; box-shadow:0 6px 15px rgba(0,0,0,0.1);
    }
    h2 { text-align:center; margin-bottom:20px; color:#2c3e50; }
    .form-group { margin-bottom:15px; }
    label { display:block; margin-bottom:5px; font-weight:bold; color:#555; }
    input, select {
      width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;
    }
    .wallet {
      margin:15px 0; padding:10px; background:#eafaf1;
      border:1px solid #1abc9c; border-radius:8px; color:#1abc9c; font-weight:bold;
    }
    .plan-details {
      margin:15px 0; padding:10px; background:#f9f9f9;
      border:1px solid #ddd; border-radius:8px; display:none;
    }
    .btn {
      width:100%; padding:12px; background:#4facfe; border:none;
      border-radius:8px; color:#fff; font-size:16px; cursor:pointer;
    }
    .btn:hover { background:#00c6fb; }
    .loading {
      display:none; text-align:center; margin-top:15px;
      font-weight:bold; color:#4facfe; animation:blink 1s infinite;
    }
    @keyframes blink { 0%{opacity:1;} 50%{opacity:0.3;} 100%{opacity:1;} }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-left">
      <a href="dashboard.html">Home</a>
      <a href="recharge.html" class="active">New Recharge</a>
      <a href="history.html">History</a>
    </div>
    <div class="nav-right">
      <button class="user-btn" id="userBtn">User ▼</button>
      <div class="dropdown" id="dropdownMenu">
        <a href="#" id="logout">Logout</a>
      </div>
    </div>
  </nav>

  <!-- Recharge form -->
  <div class="container">
    <h2>Recharge</h2>
    <form id="rechargeForm">
      <div class="form-group">
        <label for="mobile">Customer Mobile Number</label>
        <input type="text" id="mobile" maxlength="10" required>
      </div>
      <div class="form-group">
        <label for="operator">Select Operator</label>
        <select id="operator" required>
          <option value="">-- Select Operator --</option>
          <option>Jio</option>
          <option>VI</option>
          <option>BSNL</option>
          <option>Airtel</option>
        </select>
      </div>
      <div class="form-group">
        <label for="amount">Select Amount</label>
        <select id="amount" required>
          <option value="">-- Select Amount --</option>
          <option value="199">₹199</option>
          <option value="299">₹299</option>
          <option value="399">₹399</option>
          <option value="599">₹599</option>
        </select>
      </div>
      <div class="plan-details" id="planDetails"></div>
      <div class="wallet">Wallet Balance: ₹<span id="walletBalance">0</span></div>
      <button type="submit" class="btn">Pay Now</button>
      <div class="loading" id="loading">Processing Request...</div>
    </form>
  </div>

<script>
  // --- Session check ---
  const userid = localStorage.getItem("userid");
  if (!userid) {
    window.location.href = "index.html";
  }
  document.getElementById("userBtn").textContent = userid + " ▼";

  // --- Navbar dropdown ---
  const userBtn = document.getElementById("userBtn");
  const dropdownMenu = document.getElementById("dropdownMenu");
  userBtn.addEventListener("click", () => {
    dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
  });
  window.addEventListener("click", (e) => {
    if (!userBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
      dropdownMenu.style.display = "none";
    }
  });
  document.getElementById("logout").addEventListener("click", (e) => {
    e.preventDefault();
    localStorage.clear();
    window.location.href = "index.html";
  });

  // --- Wallet ---
  let wallet = parseInt(localStorage.getItem("wallet") || "1000", 10);
  const walletBalanceEl = document.getElementById("walletBalance");
  walletBalanceEl.textContent = wallet;

  // --- Plan details ---
  const amountSelect = document.getElementById("amount");
  const planDetails = document.getElementById("planDetails");
  amountSelect.addEventListener("change", () => {
    const amount = amountSelect.value;
    if(amount) {
      planDetails.style.display = "block";
      planDetails.textContent = `Plan Details: ₹${amount} recharge gives you ${
        amount==="199"?"28 days validity, 1.5GB/day":
        amount==="299"?"28 days validity, 2GB/day":
        amount==="399"?"56 days validity, 1.5GB/day":
        "84 days validity, 2GB/day"
      }`;
    } else {
      planDetails.style.display = "none";
    }
  });

  // --- Form submit (merged) ---
  const form = document.getElementById("rechargeForm");
  const loading = document.getElementById("loading");

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const mobile = document.getElementById("mobile").value.trim();
    const operator = document.getElementById("operator").value;
    const amount = parseInt(amountSelect.value,10);

    if(!/^\d{10}$/.test(mobile)) return alert("Enter valid 10-digit mobile number");
    if(!operator || !amount) return alert("Select operator and amount");
    if(wallet < amount) return alert("Insufficient wallet balance");

    loading.style.display = "block";

    // Deduct wallet locally
    wallet -= amount;
    localStorage.setItem("wallet", wallet);
    walletBalanceEl.textContent = wallet;

    // Send data to Google Sheet
    fetch("YOUR_WEB_APP_URL_HERE", {
      method: "POST",
      body: JSON.stringify({ userid, mobile, operator, amount }),
      headers: { "Content-Type": "application/json" }
    })
    .then(res => res.text())
    .then(data => {
      loading.style.display = "none";
      alert("Recharge successful and stored in Google Sheet!");
      form.reset();
      planDetails.style.display = "none";
    })
    .catch(err => {
      loading.style.display = "none";
      alert("Error saving to Google Sheet: " + err);
    });
  });

  function submitRecharge() {
    const userid = localStorage.getItem("userid");
    const mobile = document.getElementById("mobile").value.trim();
    const operator = document.getElementById("operator").value;
    const amount = document.getElementById("amount").value;

    google.script.run
      .withSuccessHandler(() => {
        alert("Recharge stored successfully in Google Sheet!");
      })
      .withFailureHandler(err => {
        alert("Error: " + err);
      })
      .saveRecharge(userid, mobile, operator, amount);
  }

  document.getElementById("rechargeForm").addEventListener("submit", e => {
    e.preventDefault();
    submitRecharge();
  });
</script>

</body>
</html>
